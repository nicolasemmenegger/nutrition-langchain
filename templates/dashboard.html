{% extends "base.html" %}

{% block extra_head %}
  <!-- Chart.js and plugins -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3"></script>
  <!-- WordCloud2 for word cloud -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.2.2/wordcloud2.min.js"></script>
{% endblock %}

{% block content %}
{% include "navbar.html" %}
<div class="flex flex-col items-center justify-start min-h-screen py-6">
  <!-- Enter date and get meals for that date. Nutrition which is a table with the following columns: Meal, Calories, Protein, Carbs, Fat -->
  <div class="flex flex-col items-center justify-start w-full max-w-6xl px-4">
    <form action="{{ url_for('views.dashboard') }}" method="post">
      <input class="border-2 border-gray-300 rounded-md p-2" type="date" name="date" id="date" value="{{ selected_date }}">
      <button class="btn btn-primary" type="submit">Get Nutrition Summary</button>
    </form>
    <div class="flex flex-col items-center justify-start w-full mt-8">
      <h1 class="text-2xl font-bold text-primary">Nutrition Summary</h1>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 w-full mt-6">
        <!-- Ingredient Word Cloud -->
        <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm lg:col-span-3">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-semibold">Most Used Ingredients (30 days)</h2>
          </div>
          <div id="ingredientCloud" class="w-full h-64 md:h-72">
            <canvas id="ingredientCloudCanvas" class="w-full h-full"></canvas>
          </div>
          <div id="ingredientList" class="mt-3 flex flex-wrap gap-2 text-xs text-gray-700"></div>
          {% if ingredient_cloud and ingredient_cloud|length > 0 %}
          <div id="ingredientListSSR" class="mt-3 flex flex-wrap gap-2 text-xs text-gray-700">
            {% for it in ingredient_cloud[:20] %}
              <span class="px-2 py-1 rounded-full bg-gray-100 border border-gray-200">{{ it.text }}</span>
            {% endfor %}
          </div>
          {% endif %}
        </div>

        <!-- Calorie trend (30 days) -->
        <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm lg:col-span-2 h-64 md:h-72">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-semibold">Calorie Trend (30 days)</h2>
          </div>
          <canvas id="calorieTrend" class="w-full h-full"></canvas>
        </div>

        <!-- Macro split donut for selected day -->
        <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm h-56 md:h-64">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-semibold">Macro Split ({{ selected_date }})</h2>
          </div>
          <canvas id="macroDonut" class="w-full h-full"></canvas>
          <div class="text-xs text-gray-500 mt-2">g per macro</div>
        </div>

        <!-- 7-day stacked macros -->
        <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm lg:col-span-3 h-64 md:h-72">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-semibold">Macros (Last 7 Days)</h2>
          </div>
          <canvas id="macroStacked" class="w-full h-full"></canvas>
        </div>
      </div>

      <div class="overflow-x-auto mt-10 w-full">
        <table class="table-auto border-collapse border border-gray-300 w-full text-sm text-left">
          <thead class="bg-gray-100">
            <tr>
              <th class="border border-gray-300 px-4 py-2">Meal</th>
              <th class="border border-gray-300 px-4 py-2 text-right">Calories</th>
              <th class="border border-gray-300 px-4 py-2 text-right">Protein (g)</th>
              <th class="border border-gray-300 px-4 py-2 text-right">Carbs (g)</th>
              <th class="border border-gray-300 px-4 py-2 text-right">Fat (g)</th>
            </tr>
          </thead>
          <tbody>
            {% for meal_type in ["breakfast", "lunch", "dinner", "snack"] %}
              {% if meals[meal_type] and meals[meal_type]["calories"] > 0 %}
                <tr class="hover:bg-gray-50">
                  <td class="border border-gray-300 px-4 py-2 font-medium">{{ meal_type.capitalize() }}</td>
                  <td class="border border-gray-300 px-4 py-2 text-right">{{ meals[meal_type]["calories"] }}</td>
                  <td class="border border-gray-300 px-4 py-2 text-right">{{ meals[meal_type]["protein"] }}</td>
                  <td class="border border-gray-300 px-4 py-2 text-right">{{ meals[meal_type]["carbs"] }}</td>
                  <td class="border border-gray-300 px-4 py-2 text-right">{{ meals[meal_type]["fat"] }}</td>
                </tr>
              {% endif %}
            {% endfor %}
            <tr class="font-bold bg-gray-200">
              <td class="border border-gray-300 px-4 py-2">Total</td>
              <td class="border border-gray-300 px-4 py-2 text-right">{{ meals["total"]["calories"] }}</td>
              <td class="border border-gray-300 px-4 py-2 text-right">{{ meals["total"]["protein"] }}</td>
              <td class="border border-gray-300 px-4 py-2 text-right">{{ meals["total"]["carbs"] }}</td>
              <td class="border border-gray-300 px-4 py-2 text-right">{{ meals["total"]["fat"] }}</td>
            </tr> 
          </tbody>
        </table>
      </div>
      
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
<script>
  // Prepare history data for charts
  const history = {{ history | tojson }};
  const labels = history.map(d => d.date);
  const calories = history.map(d => d.calories);
  const protein = history.map(d => d.protein);
  const carbs = history.map(d => d.carbs);
  const fat = history.map(d => d.fat);
  const ingredientCloud = {{ ingredient_cloud | tojson }};
  console.debug('Ingredient cloud data:', ingredientCloud);

  // Calorie trend line chart
  const calorieCtx = document.getElementById('calorieTrend');
  if (calorieCtx) {
    new Chart(calorieCtx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Calories',
          data: calories,
          borderColor: '#2563eb',
          backgroundColor: 'rgba(37,99,235,0.15)',
          fill: true,
          tension: 0.35,
          pointRadius: 0,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { ticks: { autoSkip: true, maxTicksLimit: 8 }},
          y: { beginAtZero: true, suggestedMax: Math.max(2000, Math.max(...calories) * 1.2) }
        },
        plugins: {
          legend: { display: false },
          tooltip: { mode: 'index', intersect: false }
        }
      }
    });
  }

  // Macro donut for selected day
  const macroCtx = document.getElementById('macroDonut');
  if (macroCtx) {
    const last = history[history.length - 1] || {protein: 0, carbs: 0, fat: 0};
    new Chart(macroCtx, {
      type: 'doughnut',
      data: {
        labels: ['Protein', 'Carbs', 'Fat'],
        datasets: [{
          data: [last.protein, last.carbs, last.fat],
          backgroundColor: ['#16a34a', '#f59e0b', '#ef4444'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '65%',
        plugins: { legend: { position: 'bottom' } }
      }
    });
  }

  // 7-day stacked macros bar chart
  const stackedCtx = document.getElementById('macroStacked');
  if (stackedCtx) {
    const last7 = history.slice(-7);
    new Chart(stackedCtx, {
      type: 'bar',
      data: {
        labels: last7.map(d => d.date),
        datasets: [
          { label: 'Protein', data: last7.map(d => d.protein), backgroundColor: '#16a34a', stack: 'macros' },
          { label: 'Carbs', data: last7.map(d => d.carbs), backgroundColor: '#f59e0b', stack: 'macros' },
          { label: 'Fat', data: last7.map(d => d.fat), backgroundColor: '#ef4444', stack: 'macros' },
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { stacked: true, ticks: { autoSkip: true, maxRotation: 0 } },
          y: { stacked: true, beginAtZero: true }
        },
        plugins: { legend: { position: 'bottom' } }
      }
    });
  }

  // Ingredient word cloud using wordcloud2
  (function renderCloud() {
    const container = document.getElementById('ingredientCloud');
    const canvas = document.getElementById('ingredientCloudCanvas');
    if (!container) return;
    if (!Array.isArray(ingredientCloud) || ingredientCloud.length === 0) {
      container.innerHTML = '<div class="text-sm text-gray-500">No ingredient data yet for this period.</div>';
      return;
    }
    const cloudData = ingredientCloud
      .map(d => ({ text: d.text, weight: Number(d.weight) || 0 }))
      .filter(d => d.weight > 0);
    if (cloudData.length === 0) {
      container.innerHTML = '<div class="text-sm text-gray-500">No ingredient data yet for this period.</div>';
      return;
    }
    const width = container.clientWidth || 800;
    const height = container.clientHeight || 260;
    const list = cloudData.map(d => [d.text, d.weight]);
    if (canvas) { canvas.width = width; canvas.height = height; }

    try {
      WordCloud(canvas || container, {
        list,
        gridSize: Math.round(8 * (container.offsetWidth / 1024)),
        weightFactor: (w) => 8 + Math.sqrt(w),
        fontFamily: 'Inter, ui-sans-serif, system-ui',
        color: () => {
          const palette = ['#2563eb', '#16a34a', '#f59e0b', '#ef4444', '#7c3aed', '#0ea5e9'];
          return palette[Math.floor(Math.random() * palette.length)];
        },
        rotateRatio: 0.4,
        rotationSteps: 4,
        backgroundColor: 'transparent',
        drawOutOfBound: false,
        shrinkToFit: true,
        origin: [width/2, height/2],
        shape: 'circle',
        click: () => {},
        hover: (item, dimension, event) => {}
      });

      // Hide SSR list after rendering
      const ssr = document.getElementById('ingredientListSSR');
      if (ssr) { ssr.style.display = 'none'; }

      // Update compact list
      const chips = document.getElementById('ingredientList');
      if (chips) {
        chips.innerHTML = '';
        cloudData.slice(0, 20).forEach(d => {
          const tag = document.createElement('span');
          tag.className = 'px-2 py-1 rounded-full bg-gray-100 border border-gray-200';
          tag.textContent = `${d.text}`;
          chips.appendChild(tag);
        });
      }
    } catch (e) {
      container.innerHTML = '<div class="text-sm text-red-600">Word cloud failed to render.</div>';
    }
  })();
</script>
{% endblock %}